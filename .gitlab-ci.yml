stages:
- tests
- build
- deploy
- release
- edit-repository
- push-repository

variables:
    FACTORY_PRODUCT_NAME: cadastre
    FACTORY_PACKAGE_NAME: qgis_cadastre
    FACTORY_PACKAGE_TYPE: plugin
    FACTORY_MANIFEST: ".lizcloud/factory.manifest"

version:
  stage: tests
  image:
    name: $REGISTRY_URI/infra/ci-tools:latest
  script:
    - version-helper
  tags:
    - factory-plain
  artifacts:
    reports:
      dotenv: build.env

package-zip:
  dependencies:
    - version
  stage: build
  image: $REGISTRY_URI/qgis-plugin-ci:latest
  script:
    - >
      qgis-plugin-ci
      package ${VERSION}
      --plugin-repo-url https://packages.3liz.org/pub/${FACTORY_PRODUCT_NAME}-qgis-plugin/${STATUS}/
  tags:
    - infrav3-plain
  artifacts:
    untracked: true
    expose_as: 'QGIS package'
    paths:
      - ${FACTORY_PRODUCT_NAME}.${VERSION}.zip
      - plugins.xml

build_3:
  stage: build
  script:
    - sed -i "s/^version=.*$/version=${CI_COMMIT_REF_NAME}/g" cadastre/metadata.txt
    - make -C .lizcloud -f factory.mk package
  environment:
    name: snap
  artifacts:
    paths:
      - ".lizcloud/factory.manifest"
  tags:
    - infrav3

push-zip-fetch-repo:
  dependencies:
    - version
    - package-zip
  stage: deploy
  script:
    # Upload into the plugin directory
    - upload_to_packages_server ${FACTORY_PRODUCT_NAME}.${VERSION}.zip pub/${FACTORY_PRODUCT_NAME}-qgis-plugin/${STATUS}/
    - upload_to_packages_server plugins.xml pub/${FACTORY_PRODUCT_NAME}-qgis-plugin/${STATUS}/

    # Fetch XML files
    - mkdir tmp_repository
    - pull_folder_from_packages_server pub/server-plugins-repository/${STATUS}/ tmp_repository

    # This CI job is running as "fabric" user, the next job is "factory"
    - chmod 777 -R tmp_repository/
  tags:
    - fabric
  artifacts:
    paths:
      - tmp_repository/*.xml

deploy_snap_3:
  stage: deploy
  script:
    - sed -i "s/^version=.*$/version=${CI_COMMIT_REF_NAME}/g" cadastre/metadata.txt
    - $FACTORY_SCRIPTS/deploy-package $FACTORY_PACKAGE_NAME
  environment:
    name: snap
  tags:
    - infrav3

release_prod_3:
  stage: release
  script:
    - sed -i "s/^version=.*$/version=${CI_COMMIT_REF_NAME}/g" cadastre/metadata.txt
    - $FACTORY_SCRIPTS/release-package $FACTORY_PACKAGE_NAME
  environment:
    name: production
  when: manual
  only:
    - tags
  tags:
    - infrav3


build_2:
  stage: build
  script:
    - sed -i "s/^version=.*$/version=${CI_COMMIT_REF_NAME}/g" cadastre/metadata.txt
    - make  -C .lizcloud -f fabric.mk package
  environment:
    name: snap
  tags:
    - fabric

deploy_snap_2:
  stage: deploy
  script:
    - sed -i "s/^version=.*$/version=${CI_COMMIT_REF_NAME}/g" cadastre/metadata.txt
    - sudo -u fabric fab snap deploy:qgis3_cadastre,force=true
  environment:
    name: snap
  tags:
    - fabric

release_prod_2:
  stage: release
  script:
    - sed -i "s/^version=.*$/version=${CI_COMMIT_REF_NAME}/g" cadastre/metadata.txt
    - sudo -u fabric fab prod release:qgis3_cadastre
  environment:
    name: production
  when: manual
  only:
    - tags
  tags:
    - fabric

tickets:
  stage: release
  when: manual
  only:
    - tags
  image:
    name: $REGISTRY_URI/infra/ci-tools:latest
  script:
    - create_ticket.py
  tags:
    - factory-plain

edit-repository:
  stage: edit-repository
  dependencies:
    - package-zip
    - push-zip-fetch-repo
  before_script:
    - PATH=$PATH:~/.local/bin
    - pip3 install --user qgis-plugin-repo
  script:
    - qgis-plugin-repo merge plugins.xml tmp_repository/*.xml
  tags:
    - factory
  artifacts:
    untracked: true
    paths:
      - tmp_repository/*.xml

push-repository:
  stage: push-repository
  dependencies:
    - version
    - edit-repository
  script:
    - upload_folder_to_packages_server tmp_repository/ pub/server-plugins-repository/${STATUS}/
  tags:
    - fabric
